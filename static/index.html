<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Web Simulant Control Plane</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0e1014;
        --bg-2: #151a23;
        --bg-3: #1f2632;
        --text: #f6f3ee;
        --muted: #c7c0b7;
        --ink: #0b0d10;
        --accent: #ffb454;
        --accent-2: #7ad7f0;
        --accent-3: #c7ff9c;
        --danger: #ff6b6b;
        --card: rgba(255, 255, 255, 0.05);
        --card-2: rgba(255, 255, 255, 0.08);
        --border: rgba(255, 255, 255, 0.12);
        --shadow: 0 18px 50px rgba(0, 0, 0, 0.35);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, sans-serif;
        color: var(--text);
        background:
          radial-gradient(1400px 800px at 10% -20%, #283041, transparent 60%),
          radial-gradient(1200px 600px at 120% 20%, #1f2f2f, transparent 55%),
          linear-gradient(140deg, var(--bg), var(--bg-2));
        min-height: 100vh;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 24px 80px;
      }

      .hero {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 24px 28px;
        border-radius: 18px;
        background: linear-gradient(
          120deg,
          rgba(255, 180, 84, 0.12),
          rgba(122, 215, 240, 0.08)
        );
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .hero::after {
        content: "";
        position: absolute;
        width: 240px;
        height: 240px;
        right: -60px;
        top: -80px;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 180, 84, 0.3),
          transparent 70%
        );
        filter: blur(2px);
      }

      .hero h1 {
        margin: 0 0 8px;
        font-size: 32px;
        letter-spacing: 0.5px;
      }

      .hero .subtitle {
        margin: 0;
        color: var(--muted);
      }

      .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(122, 215, 240, 0.4);
        background: rgba(122, 215, 240, 0.12);
        color: var(--accent-2);
        font-weight: 600;
      }

      .grid {
        display: grid;
        gap: 20px;
        margin-top: 28px;
      }

      .grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        backdrop-filter: blur(6px);
        box-shadow: var(--shadow);
      }

      .card h2 {
        margin: 0 0 12px;
        font-size: 18px;
        text-transform: uppercase;
        letter-spacing: 1.4px;
        color: var(--accent-3);
      }

      .keyline {
        border-top: 1px solid var(--border);
        margin: 18px 0;
      }

      .endpoint-list {
        display: grid;
        gap: 16px;
      }

      .endpoint {
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 14px;
        padding: 16px;
        background: var(--card-2);
      }

      .endpoint-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .endpoint h3 {
        margin: 0;
        font-size: 16px;
      }

      .pill {
        font-family: "JetBrains Mono", ui-monospace, monospace;
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .mono {
        font-family: "JetBrains Mono", ui-monospace, monospace;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .btn {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 10px 16px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn.primary {
        background: linear-gradient(
          120deg,
          rgba(255, 180, 84, 0.8),
          rgba(255, 180, 84, 0.4)
        );
        color: var(--ink);
        border: none;
      }

      .btn.secondary {
        background: rgba(122, 215, 240, 0.12);
        border-color: rgba(122, 215, 240, 0.5);
        color: var(--accent-2);
      }

      .btn.ghost {
        background: transparent;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .note {
        color: var(--muted);
        font-size: 13px;
      }

      .status-grid {
        display: grid;
        gap: 8px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
      }

      .banner {
        margin-top: 16px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(255, 107, 107, 0.12);
        border: 1px solid rgba(255, 107, 107, 0.4);
        color: #ffd6d6;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(10, 12, 16, 0.6);
        align-items: center;
        justify-content: center;
        padding: 24px;
      }

      .modal.active {
        display: flex;
      }

      .modal-card {
        background: var(--bg-3);
        padding: 24px;
        border-radius: 16px;
        border: 1px solid var(--border);
        max-width: 560px;
        width: 100%;
      }

      .fade-in {
        animation: fadeIn 0.6s ease forwards;
        opacity: 0;
      }

      .stagger > * {
        animation: rise 0.5s ease forwards;
        opacity: 0;
        transform: translateY(12px);
      }

      .stagger > *:nth-child(1) {
        animation-delay: 0.05s;
      }
      .stagger > *:nth-child(2) {
        animation-delay: 0.12s;
      }
      .stagger > *:nth-child(3) {
        animation-delay: 0.18s;
      }
      .stagger > *:nth-child(4) {
        animation-delay: 0.24s;
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }

      @keyframes rise {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 720px) {
        .hero {
          flex-direction: column;
          align-items: flex-start;
        }

        .actions {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="page fade-in">
      <header class="hero">
        <div>
          <h1>Web Simulant</h1>
          <p class="subtitle">
            Control plane for simulated APIs and test harnesses.
          </p>
          <p class="note mono">
            Engine: http://localhost:8080 | Control Plane: http://localhost:8081
          </p>
        </div>
        <div class="status-chip" data-status="running">
          <span class="mono">Status</span>
          <strong>Running</strong>
        </div>
      </header>

      <section class="grid grid-2 stagger" aria-label="Configuration">
        <div class="card">
          <h2>Configuration</h2>
          <div class="status-grid">
            <div class="status-item">
              <span>Current</span
              ><span class="mono" data-config-name>None loaded</span>
            </div>
            <div class="status-item">
              <span>Endpoints</span
              ><span class="mono" data-config-count>0</span>
            </div>
            <div class="status-item">
              <span>Loaded</span><span class="mono" data-config-loaded>--</span>
            </div>
          </div>
          <div class="keyline"></div>
          <div class="actions">
            <button class="btn primary" data-action="upload">
              Upload Config
            </button>
            <button class="btn secondary" data-action="download">
              Download Config
            </button>
            <button class="btn ghost" data-action="validate">
              Validate Only
            </button>
          </div>
          <input
            id="config-input"
            type="file"
            accept=".yaml,.yml,.json"
            hidden
          />
          <p class="note">Upload YAML or JSON to apply a new configuration.</p>
        </div>

        <div class="card">
          <h2>Runtime</h2>
          <div class="status-grid">
            <div class="status-item">
              <span>Engine</span
              ><span class="mono" data-engine-status>Ready</span>
            </div>
            <div class="status-item">
              <span>Control Plane</span
              ><span class="mono" data-control-status>Ready</span>
            </div>
            <div class="status-item">
              <span>Version</span><span class="mono" data-version>1.0.0</span>
            </div>
          </div>
          <div class="keyline"></div>
          <div class="actions">
            <button class="btn" data-action="refresh">Refresh Endpoints</button>
            <button class="btn" data-action="status">Get Status</button>
          </div>
          <div class="banner" data-banner hidden>
            No configuration loaded yet. Upload to begin.
          </div>
        </div>
      </section>

      <section
        class="card"
        aria-label="Active Endpoints"
        style="margin-top: 28px"
      >
        <div class="endpoint-header">
          <h2 style="margin: 0">Active Endpoints</h2>
          <button class="btn" data-action="refresh">Refresh</button>
        </div>
        <p class="note">Endpoints appear after a configuration is loaded.</p>
        <div class="endpoint-list" data-endpoint-list>
          <div class="endpoint" data-endpoint data-template hidden>
            <div class="endpoint-header">
              <h3>ID: sample-endpoint</h3>
              <span class="pill">GET /api/sample</span>
            </div>
            <p class="note">Latency: normal (mean: 50ms, stddev: 10ms)</p>
            <p class="note">Errors: 0.1% -> [500]</p>
            <div class="actions">
              <button class="btn ghost" disabled>Expand</button>
              <button class="btn" disabled>Copy curl</button>
            </div>
          </div>
        </div>
      </section>

      <div
        class="modal"
        id="modal"
        role="dialog"
        aria-modal="true"
        aria-hidden="true"
      >
        <div class="modal-card">
          <h2 data-modal-title>Notification</h2>
          <div class="note" data-modal-body>
            Modal messaging will be wired in Phase 1.9.
          </div>
          <div class="actions">
            <button class="btn" data-action="close-modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      const ui = {
        configName: document.querySelector("[data-config-name]"),
        configCount: document.querySelector("[data-config-count]"),
        configLoaded: document.querySelector("[data-config-loaded]"),
        engineStatus: document.querySelector("[data-engine-status]"),
        controlStatus: document.querySelector("[data-control-status]"),
        version: document.querySelector("[data-version]"),
        banner: document.querySelector("[data-banner]"),
        endpointList: document.querySelector("[data-endpoint-list]"),
        endpointTemplate: document.querySelector(
          "[data-endpoint][data-template]",
        ),
        modal: document.getElementById("modal"),
        modalTitle: document.querySelector("[data-modal-title]"),
        modalBody: document.querySelector("[data-modal-body]"),
        configInput: document.getElementById("config-input"),
      };

      let fileMode = "upload";

      function setBanner(show) {
        if (show) {
          ui.banner.removeAttribute("hidden");
        } else {
          ui.banner.setAttribute("hidden", "hidden");
        }
      }

      function showModal(title, bodyHtml) {
        ui.modalTitle.textContent = title;
        ui.modalBody.innerHTML = bodyHtml;
        ui.modal.classList.add("active");
        ui.modal.setAttribute("aria-hidden", "false");
      }

      function hideModal() {
        ui.modal.classList.remove("active");
        ui.modal.setAttribute("aria-hidden", "true");
      }

      function setStatusData(status) {
        ui.version.textContent = status.version || "unknown";
        const endpointsCount = status.endpoints_count || 0;
        ui.configCount.textContent = endpointsCount;
        if (status.config_loaded) {
          setBanner(false);
        } else {
          ui.configName.textContent = "None loaded";
          ui.configLoaded.textContent = "--";
          setBanner(true);
        }
      }

      async function fetchJson(url, options) {
        const response = await fetch(url, options);
        const data = await response.json();
        return { response, data };
      }

      async function loadStatus() {
        try {
          const { data } = await fetchJson("/api/status");
          setStatusData(data);

          if (data.config_loaded) {
            await loadConfigMetadata();
            await loadEndpoints();
          } else {
            renderEndpoints([]);
          }
        } catch (error) {
          showModal("Status Error", "Failed to load status.");
        }
      }

      async function loadConfigMetadata() {
        try {
          const response = await fetch("/api/config/export?format=json");
          if (!response.ok) {
            return;
          }
          const config = await response.json();
          ui.configName.textContent = config.metadata?.name || "Loaded config";
          ui.configLoaded.textContent = new Date().toISOString();
        } catch (error) {
          ui.configLoaded.textContent = "--";
        }
      }

      async function loadEndpoints() {
        try {
          const { data } = await fetchJson("/api/endpoints");
          renderEndpoints(data.endpoints || []);
          ui.configCount.textContent = data.endpoints_count || 0;
        } catch (error) {
          showModal("Endpoints Error", "Failed to load endpoints list.");
        }
      }

      function renderEndpoints(endpoints) {
        ui.endpointList.innerHTML = "";

        if (!endpoints.length) {
          const empty = document.createElement("p");
          empty.className = "note";
          empty.textContent = "No endpoints loaded yet.";
          ui.endpointList.appendChild(empty);
          return;
        }

        endpoints.forEach((endpoint) => {
          const node = ui.endpointTemplate.cloneNode(true);
          node.removeAttribute("hidden");
          node.removeAttribute("data-template");

          const header = node.querySelector("h3");
          const pill = node.querySelector(".pill");
          const notes = node.querySelectorAll(".note");
          const copyButton = node.querySelector(".actions .btn:last-child");

          header.textContent = `ID: ${endpoint.id}`;
          pill.textContent = `${endpoint.method} ${endpoint.path}`;
          notes[0].textContent = `Latency: ${endpoint.latency.distribution} (${formatLatency(endpoint.latency.params)})`;
          notes[1].textContent = `Errors: ${(endpoint.error_rate * 100).toFixed(2)}% -> [${endpoint.response_status}]`;

          copyButton.disabled = false;
          copyButton.textContent = "Copy curl";
          copyButton.addEventListener("click", () => copyCurl(endpoint));

          ui.endpointList.appendChild(node);
        });
      }

      function formatLatency(params) {
        if (params.delay_ms !== undefined) {
          return `delay: ${params.delay_ms}ms`;
        }
        if (params.mean_ms !== undefined) {
          return `mean: ${params.mean_ms}ms, stddev: ${params.stddev_ms}ms`;
        }
        if (params.rate !== undefined) {
          return `rate: ${params.rate}`;
        }
        if (params.min_ms !== undefined) {
          return `min: ${params.min_ms}ms, max: ${params.max_ms}ms`;
        }
        return "n/a";
      }

      function copyCurl(endpoint) {
        const command = `curl http://localhost:8080${endpoint.path}`;
        navigator.clipboard.writeText(command).then(() => {
          showModal("Copied", `<p>${command}</p>`);
        });
      }

      async function sendConfig(action, file) {
        if (!file) {
          return;
        }

        if (action === "upload") {
          const form = new FormData();
          form.append("config", file, file.name);
          const { response, data } = await fetchJson(
            "/api/config/import/multipart",
            {
              method: "POST",
              body: form,
            },
          );

          if (!response.ok) {
            showModal("Upload Failed", formatErrors(data));
            return;
          }

          showModal("Upload Complete", formatSummary(data.summary));
          await loadStatus();
          return;
        }

        const content = await file.text();
        const contentType =
          file.name.endsWith(".json") ?
            "application/json"
          : "application/x-yaml";

        const { response, data } = await fetchJson("/api/config/validate", {
          method: "POST",
          headers: { "Content-Type": contentType },
          body: content,
        });

        if (!response.ok) {
          showModal("Validation Failed", formatErrors(data));
          return;
        }

        showModal("Validation Passed", formatSummary(data.summary));
      }

      function formatSummary(summary) {
        if (!summary) {
          return "<p>Completed.</p>";
        }
        const items = (summary.endpoints || []).map(
          (endpoint) =>
            `<li>${endpoint.id} (${endpoint.method} ${endpoint.path})</li>`,
        );
        return `
          <p>Endpoints loaded: ${summary.endpoints_loaded || summary.endpoints_count || 0}</p>
          <ul>${items.join("")}</ul>
        `;
      }

      function formatErrors(payload) {
        const errors = payload.errors || [];
        const items = errors.map(
          (error) =>
            `<li><strong>${error.field || "error"}:</strong> ${error.error || error}</li>`,
        );
        return `
          <p>${payload.message || "Request failed."}</p>
          <ul>${items.join("")}</ul>
        `;
      }

      document.querySelectorAll("[data-action]").forEach((button) => {
        button.addEventListener("click", () => {
          const action = button.dataset.action;
          if (action === "upload" || action === "validate") {
            fileMode = action;
            ui.configInput.value = "";
            ui.configInput.click();
            return;
          }
          if (action === "download") {
            window.location.href = "/api/config/export?format=yaml";
            return;
          }
          if (action === "refresh") {
            loadEndpoints();
            return;
          }
          if (action === "status") {
            loadStatus();
            return;
          }
          if (action === "close-modal") {
            hideModal();
          }
        });
      });

      ui.configInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          sendConfig(fileMode, file);
        }
      });

      loadStatus();
    </script>
  </body>
</html>
